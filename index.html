<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NS-Island Escape 3-D</title>
    <!-- Babylon.js & Cannon.js -->
    <script src="https://cdn.jsdelivr.net/npm/babylonjs@6.46.0/babylon.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babylonjs-loaders@6.46.0/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"></script>
    <style>
      :root { --purple: #9146ff; }
      html,body{width:100%;height:100%;margin:0;overflow:hidden;background:#000;color:#fff;font-family:Arial,sans-serif;}
      #renderCanvas{width:100%;height:100%;touch-action:none;}
      #hud{position:absolute;top:10px;left:50%;transform:translateX(-50%);text-align:center;}
      #hud span{margin:0 5px;}
      #mobileControls{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:40px;}
      .btn{width:60px;height:60px;border:2px solid #fff;border-radius:50%;display:flex;justify-content:center;align-items:center;color:#fff;font-size:24px;background:var(--purple);opacity:.7;}
      @media(hover:hover){#mobileControls{display:none;}}
    </style>
  </head>
  <body>
    <canvas id="renderCanvas"></canvas>
    <div id="hud"><span id="score">Coins 0 / 5</span><span id="stage">Stage 1 / 4</span></div>
    <div id="mobileControls">
      <div class="btn" id="leftBtn">◀</div>
      <div class="btn" id="jumpBtn">⤒</div>
      <div class="btn" id="rightBtn">▶</div>
    </div>
    <script>
      const canvas=document.getElementById('renderCanvas');
      const engine=new BABYLON.Engine(canvas,true);
      let stage=1,coinsCollected=0,scene,player,input={left:false,right:false,jump:false};
      function createScene(){
        scene=new BABYLON.Scene(engine);
        scene.clearColor=new BABYLON.Color4(0,0,0,1);
        scene.enablePhysics(new BABYLON.Vector3(0,-9.81,0),new BABYLON.CannonJSPlugin());
        const camera=new BABYLON.FollowCamera('cam',new BABYLON.Vector3(0,5,-10),scene);
        camera.radius=10;camera.heightOffset=4;camera.attachControl(canvas,true);
        new BABYLON.HemisphericLight('light',new BABYLON.Vector3(0,1,0),scene);
        const ground=BABYLON.MeshBuilder.CreateGround('ground',{width:50,height:50},scene);
        ground.material=new BABYLON.StandardMaterial('gm',scene);ground.material.diffuseColor=new BABYLON.Color3(0.05,0.05,0.05);
        ground.physicsImpostor=new BABYLON.PhysicsImpostor(ground,BABYLON.PhysicsImpostor.BoxImpostor,{mass:0},scene);
        player=BABYLON.MeshBuilder.CreateCapsule('player',{height:2,radius:0.5},scene);
        player.position.y=2;player.material=new BABYLON.StandardMaterial('pm',scene);player.material.diffuseColor=BABYLON.Color3.FromHexString('#9146ff');
        player.physicsImpostor=new BABYLON.PhysicsImpostor(player,BABYLON.PhysicsImpostor.CapsuleImpostor,{mass:1,restitution:0.1,friction:0.6},scene);
        camera.lockedTarget=player;
        buildStage(stage);
        return scene;
      }
      function buildStage(n){
        const gap=5,y=2;
        for(let i=0;i<5;i++){
          const plat=BABYLON.MeshBuilder.CreateBox('plat'+i,{width:4,height:0.5,depth:4},scene);
          plat.position.set(i*gap,y,0);
          plat.material=new BABYLON.StandardMaterial('plm',scene);plat.material.diffuseColor=new BABYLON.Color3(0.15,0.15,0.15);
          plat.physicsImpostor=new BABYLON.PhysicsImpostor(plat,BABYLON.PhysicsImpostor.BoxImpostor,{mass:0},scene);
          const coin=BABYLON.MeshBuilder.CreateCylinder('coin'+i,{diameter:1,height:0.2},scene);
          coin.position.set(i*gap,y+1.5,0);
          coin.material=new BABYLON.StandardMaterial('cm',scene);coin.material.diffuseColor=BABYLON.Color3.Yellow();
          coin.rotate(BABYLON.Axis.Y,Math.PI/4,scene);
          coin.actionManager=new BABYLON.ActionManager(scene);
          coin.actionManager.registerAction(new BABYLON.ExecuteCodeAction({trigger:BABYLON.ActionManager.OnIntersectionEnterTrigger,parameter:player},()=>{
            if(!coin.isDisposed()){coin.dispose();coinsCollected++;updateHUD();if(coinsCollected>=5)nextStage();}});
          );
        }
      }
      function updateHUD(){document.getElementById('score').textContent=`Coins ${coinsCollected} / 5`;document.getElementById('stage').textContent=`Stage ${stage} / 4`;}
      function nextStage(){if(stage>=4){victory();return;}stage++;coinsCollected=0;scene.meshes.filter(m=>m.name.startsWith('plat')||m.name.startsWith('coin')).forEach(m=>m.dispose());buildStage(stage);updateHUD();player.physicsImpostor.setLinearVelocity(new BABYLON.Vector3());player.position=new BABYLON.Vector3(0,2,0);}
      function victory(){alert('🏴‍☠️ You escaped NS Island in 3-D!');stage=1;coinsCollected=0;nextStage();}
      window.addEventListener('keydown',e=>{if(e.code==='ArrowLeft')input.left=true;if(e.code==='ArrowRight')input.right=true;if(e.code==='Space')input.jump=true;});
      window.addEventListener('keyup',e=>{if(e.code==='ArrowLeft')input.left=false;if(e.code==='ArrowRight')input.right=false;if(e.code==='Space')input.jump=false;});
      [['leftBtn','left'],['rightBtn','right'],['jumpBtn','jump']].forEach(([id,key])=>{const btn=document.getElementById(id);btn.addEventListener('touchstart',()=>input[key]=true);btn.addEventListener('touchend',()=>input[key]=false);});
      engine.runRenderLoop(()=>{if(scene){let vel=player.physicsImpostor.getLinearVelocity();if(input.left)vel.x=-5;else if(input.right)vel.x=5;else vel.x=0;if(input.jump&&Math.abs(vel.y)<0.05)vel.y=7;player.physicsImpostor.setLinearVelocity(vel);scene.render();}});
      window.addEventListener('resize',()=>engine.resize());
      createScene();updateHUD();
    </script>
  </body>
</html>
